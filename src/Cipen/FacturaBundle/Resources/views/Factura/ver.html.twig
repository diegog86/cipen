{% extends "ComunComunBundle:Default:layout.html.twig" %}

{% block admin_title %}
    Ver facturación
{% endblock %}

{% block admin_actions %}
    <li><a href="{{ path('factura') }}"><i class="icon-chevron-left"></i> Volver a listado</a></li>  
    <li class="dropdown">    

        <a class="dropdown-toggle"  data-toggle="dropdown" data-target="#" href="javascript:void(0)">
          <i class="icon-print"></i> &nbsp;Imprimir
          <b class="caret"></b>
        </a>
        <ul class="dropdown-menu nav pull-right" >
            <li>
                <a href="{{ path('factura_imprimir_resumen_individual',{id:factura.id}) }}">
                    Imprimir resumen de facturación
                </a>
            </li>
            <li>
                <a href="{{ path('factura_imprimir_resumen_fiscal_individual',{id:factura.id}) }}">
                    Imprimir facturas fiscales
                </a>
             </li>
             <li>
                 <a href="{{ path('factura_imprimir_resumen_general',{id:factura.id}) }}">
                     Imprimir resumen general de facturación
                 </a>
             </li>
        </ul>

    
    </li>
{% endblock %}
    
{% set admin_menu_active = 'factura' %}
    
{% block admin_content %}
        
    <form class="form-horizontal" method="POST" action="{{ path('factura_editar',{id:factura.id}) }}">  
    
    {% for facturaInternacion in facturaInternaciones %}
        <h4>{{ factura.obraSocial is not empty ? "Obra social "~factura.obraSocial : "Sin obra social" }}</h4>
        {% set internacion = facturaInternacion.internacion %}
        <div class="row-fluid">
            <table class="table">
                <tr >
                    <th style="border:none" width="25%">Periodo: {{ periodo }}</th>
                    <th style="border:none" width="25%">Historia clínica n°: {{ internacion.numeroFormateado }} </th>
                    <th style="border:none" width="49%">
                        N° factura:     
                        {% if tipo_total == "porcentaje_10_90" %}
                            <div class="input-append" style="width: 180px; margin-right: 15px;">
                                {{ form_widget(form.facturaInternacion[loop.index-1].facturaFiscal, {'attr':{class:'span10','placeholder':'Factura 90%' }}) }}                                
                                <span class="add-on">90%</span>
                            </div>

                            <div class="input-append" style="width: 180px">
                                {{ form_widget(form.facturaInternacion[loop.index-1].facturaFiscalExtra, {'attr':{class:'span10','placeholder':'Factura 10%' }}) }}                                    
                                <span class="add-on">10%</span>
                            </div>
                                                                    
                       {% else %} 
                           {{ form_widget(form.facturaInternacion[loop.index-1].facturaFiscal, {'attr':{style:'margin-top:-5px;; width: 370px' }}) }}

                       {% endif %}
                            
                    
                    </th>
                </tr>
                <tr>
                    <th style="border:none">
                       {% if factura.obraSocial is not empty %}
                            Afiliado n°: {{ internacion.numeroObraSocialPaciente  }} 
                       {% else %}
                            Paciente n°: {{ internacion.paciente.numero  }} 
                       {% endif %}
                    </th>
                    <th style="border:none">DNI: {{ internacion.paciente.dni is not empty ? internacion.paciente.dni : ""  }}</th>
                    <th style="border:none">Apellido, nombre: {{ internacion.paciente.apellido~", "~internacion.paciente.nombre }}</th>
                </tr>
                <tr>
                    <th style="border:none">Fecha de ingreso: {{ internacion.fechaHoraIngreso | date('d/m/Y') }}</th>
                    <th style="border:none">Fecha de egreso: {{ internacion.fechaHoraIngreso | date('d/m/Y') }} </th>
                    <th style="border:none">                       
                        <div class="pull-left">
                                {{ form_widget(form.facturaInternacion[loop.index-1].informacionExtraLabel, {'attr':{style:'margin-top:-5px; width: 120px' }}) }} :
                        </div>
                        <div class="pull-left">
                                {{ form_widget(form.facturaInternacion[loop.index-1].informacionExtraValor, {'attr':{style:'margin-top:-5px; width: 300px' }}) }}
                        </div>                      
                    </th>                
                </tr>
            </table>
            {{ _self.internacion(facturaInternacion.internacion,prestaciones,tipo_total) }}
        </div>
        {% if loop.last != true %} <hr> {% endif %}
    {% endfor %}
    
    {% macro internacion (internacion,prestaciones,tipo_total) %}
        
        <table class="table table-bordered table-striped table-align-center">
            <thead>
                <tr>
                    <th width="30">Cant.</th>
                    <th width="100">Código</th>
                    <th class="col-left" width="{{ tipo_total == "porcentaje_10_90" ? "330" : "410" }}">Descripción</th>
                    <th width="100">Mat. Prof.</th>
                    {% if tipo_total == "porcentaje_10_90" %}
                        <th width="80">90%</th>
                        <th width="80">10%</th>
                    {% else %}
                        <th width="80">Valor unitario</th>
                   {% endif %}
                    <th width="80">Total</th>
                </tr>
            </thead>
            <tbody>

            {% set totalSum = 0 %}
            {% set diezPorcentSum = 0 %}
            {% set noventaPorcentSum = 0 %}
            {% set valorUnitarioSum = 0 %}
            
            {% for prestacion in prestaciones[internacion.id] %}
            
                
                {% set totalSum = totalSum + prestacion.total %}
                {% set valorUnitarioSum = valorUnitarioSum + prestacion.valor_unitario %}
                {% if tipo_total == "porcentaje_10_90" %}
                    {% set diezPorcentSum = diezPorcentSum + prestacion.porcentaje_10 %}
                    {% set noventaPorcentSum = noventaPorcentSum + prestacion.porcentaje_90 %}            
                {% endif %}
    
                <tr>
                    <td>{{ prestacion.cantidad }}</td>
                    <td>{{ prestacion.tipo == "modulo" ?  prestacion.object.codigo : prestacion.object.acto.codigo }}</td>
                    <td class="col-left">
                        {{ prestacion.tipo == "modulo" ?  prestacion.object.descripcion : prestacion.object.acto.descripcion }}
                    </td>
                    <td>{{ internacion.prescriptor.matricula }}{{ internacion.obraSocialPaciente.sufijoMatriculaPersonal}}</td>
                    
                    {% if tipo_total == "porcentaje_10_90" %}
                        <td>{{ prestacion.porcentaje_90 }}</td>
                        <td>{{  prestacion.porcentaje_10 }}</td>
                     {% else %}
                        <td>{{  prestacion.valor_unitario }}</td>
                     {% endif %}
                    <td>{{ prestacion.total }}</td>                    
                </tr>
            {% endfor %}
            </tbody>
        </table>
        
        <table class="table table-bordered pull-right table-align-center" style="width:{{ tipo_total == "porcentaje_10_90" ? "445" : "340" }}px">
            <tr>
                <th width="200">Totales</th>
                {% if tipo_total == "porcentaje_10_90" %}
                    <th width="265">{{noventaPorcentSum}}</th>
                    <th width="265">{{ diezPorcentSum }}</th>
                {% else %}
                    <th width="265">{{ valorUnitarioSum }}</th>
                {% endif %}
                <th width="260">{{totalSum}}</th>
            </tr>
        </table>
    
    {% endmacro %}
       
        <div class="form-actions">
            <button type="submit" class="btn btn-success pull-right">Guardar</button>
        </div>

    </form>
    
{% endblock %}

{% block javascripts %}
     
    {{ parent() }}
    <script type="text/javascript">
         $('.dropdown-toggle').dropdown()         
    </script>
        
{% endblock %}