<html>
    <head>
        <link type="text/css" rel="media"
              href="{{ asset('bundles/comuncomun/css/factura-pdf.css') }}" />
    </head>

    <body>
     {% for facturaInternacion in facturaInternaciones %}
        {% if tipo_total == "porcentaje_10_90" %}
            {{ _self.facura(factura,facturaInternacion,prestaciones,tipo_total,periodo,'al90') }}
             <pagebreak type="NEXT-ODD" resetpagenum="1" pagenumstyle="i" suppress="off" />
            {{ _self.facura(factura,facturaInternacion,prestaciones,tipo_total,periodo,'al10') }}
        {% else %}
            {{ _self.facura(factura,facturaInternacion,prestaciones,tipo_total,periodo,'unitario') }}
        {% endif %}
        
        {%if loop.last == false %}
            <pagebreak type="NEXT-ODD" resetpagenum="1" pagenumstyle="i" suppress="off" />
        {% endif %}
            
     {% endfor %}  
        
    {% macro facura(factura,facturaInternacion,prestaciones,tipo_total,periodo,tipo_total_al10_al90_unitario) %}
        
       

            <div class="factura-fiscal-section-1">

                <div class="factura-fiscal-fecha">
                    <div>{{ 'NOW' | date('Y') }}</div>
                    <div>{{ 'NOW' | date('m') }}</div> 
                    <div>{{ 'NOW' | date('d') }}</div>
                </div>
            </div>

            <div class="factura-fiscal-section-2">
                <div>
                    {{ factura.obraSocial is not empty ? factura.obraSocial : "" }}
                </div>
                 <div>
                    {{ factura.obraSocial is not empty ? 
                        factura.obraSocial.direccionNumero~" - "~
                        factura.obraSocial.direccionCalle~" - "~
                        factura.obraSocial.direccionNumero : "" 
                     }}
                </div>
            </div>

            <div class="factura-fiscal-section-3">

            {% set internacion = facturaInternacion.internacion %}

                <table class="table table-align-left">
                    <thead>
                        <tr>
                            <th  width="25%">Periodo: {{ periodo is not empty ? periodo : "-" }}</th>
                            <th  width="28%">Historia clínica n°: {{ internacion.numero is not empty ? internacion.getNumeroFormateado : '' }} </th>
                            <th  width="46%"> {{ facturaInternacion.informacionExtraLabel is not empty and facturaInternacion.informacionExtraValor is not empty  ? facturaInternacion.informacionExtraLabel~": "~facturaInternacion.informacionExtraValor : "" }} </th>
                        </tr>
                        <tr>
                            <th>
                               {% if factura.obraSocial is not empty %}
                                   Afiliado n°: {{ internacion.numeroObraSocialPaciente  }} 
                               {% else %}
                                   Paciente n°: {{ internacion.paciente.numero  }} 
                               {% endif %}
                            </th>
                            <th >
                                DNI: {{ internacion.paciente.dni is not empty ? internacion.paciente.dni : "-"  }}</th>
                            <th>
                                Apellido, nombre: {{ internacion.paciente.apellido~", "~internacion.paciente.nombre }}
                            </th>
                        </tr>
                    </thead>
                    </table>
            </div>
            <div class="factura-fiscal-section-4">
                    {{ _self.internacion(facturaInternacion.internacion,prestaciones,tipo_total,tipo_total_al10_al90_unitario) }}
            </div>

            <div class="factura-fiscal-total">

              {% set totalSum = 0 %}
              {% set diezPorcentSum = 0 %}
              {% set noventaPorcentSum = 0 %}
              {% set valorUnitarioSum = 0 %}

              {% for prestacion in prestaciones[internacion.id] %}

                  {% set totalSum = totalSum + prestacion.total %}
                  {% set valorUnitarioSum = valorUnitarioSum + prestacion.valor_unitario %}
                  {% if tipo_total == "porcentaje_10_90" %}
                      {% set diezPorcentSum = diezPorcentSum + prestacion.porcentaje_10 %}
                      {% set noventaPorcentSum = noventaPorcentSum + prestacion.porcentaje_90 %}            
                  {% endif %}   
                
              {% endfor %}
               
               {% if tipo_total == "porcentaje_10_90" %}
               
                   {% if tipo_total_al10_al90_unitario == "al90" %}
                       $ {{ noventaPorcentSum }}
                   {% else %}
                       $ {{ diezPorcentSum }}
                   {% endif %}
               
               {% else %}
                       $ {{ totalSum }}
               {% endif %}
               

            </div>
    
    {% endmacro %}
            
    {% macro internacion (internacion,prestaciones,tipo_total,tipo_total_al10_al90_unitario) %}
        
        <table class="table-bordered" >
            <thead>
                <tr>
                    <th  width="30">Cant.</th>
                    <th width="100">Código</th>
                    <th class="text-left" width="{{ tipo_total == "porcentaje_10_90" ? "330" : "410" }}">Descripción</th>
                    {% if tipo_total == "porcentaje_10_90" %}
                        <th width="80">90%</th>
                        <th width="80">10%</th>
                    {% else %}
                        <th width="80">Val. unit.</th>
                   {% endif %}
                    <th width="80">Total</th>
                </tr>
            </thead>
            <tbody>

            {% set totalSum = 0 %}
            {% set diezPorcentSum = 0 %}
            {% set noventaPorcentSum = 0 %}
            {% set valorUnitarioSum = 0 %}
            
            {% for prestacion in prestaciones[internacion.id] %}

    
                <tr>
                    <td align="center">{{ prestacion.cantidad }}</td>
                    <td align="center" >{{ prestacion.tipo == "modulo" ?  prestacion.object.codigo : prestacion.object.acto.codigo }}</td>
                    <td>
                        {{ prestacion.tipo == "modulo" ?  prestacion.object.descripcion : prestacion.object.acto.descripcion }}
                    </td>
                    
                    {% if tipo_total == "porcentaje_10_90" %}
                        <td align="center">$ {{ tipo_total_al10_al90_unitario == "al90" ? prestacion.porcentaje_90 : 0 }}</td>
                        <td align="center">$ {{ tipo_total_al10_al90_unitario == "al10" ? prestacion.porcentaje_10 : 0 }}</td>
                        <td align="center">$ {{ tipo_total_al10_al90_unitario == "al90" ? prestacion.porcentaje_90 : prestacion.porcentaje_10 }}</td>  
                     {% else %}
                        <td align="center">$ {{  prestacion.valor_unitario }}</td>
                        <td align="center">$ {{ prestacion.total }}</td>  
                     {% endif %}
                                      
                </tr>
            {% endfor %}
            </tbody>
        </table>
                 
    {% endmacro %}

               
             
    </body>
</html>